<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178666696-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-178666696-1');</script><meta name=generator content="Hugo 0.71.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=author content="Michele Sciabarrà"><meta name=keywords content="Kubernetes"><meta name=description content="A simple cloud-init script to build automatically Kubernetes based on MicroK8s, and test it with multipass."><meta property="og:title" content="Deploy MicroK8s  with cloud-init"><meta property="og:description" content="A simple cloud-init script to build automatically Kubernetes based on MicroK8s, and test it with multipass."><meta property="og:type" content="article"><meta property="og:url" content="https://openwhisk.blog/post/kubernetes/microk8s-init/"><meta property="article:published_time" content="2021-06-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy MicroK8s  with cloud-init"><meta name=twitter:description content="A simple cloud-init script to build automatically Kubernetes based on MicroK8s, and test it with multipass."><link rel=stylesheet type=text/css media=screen href=https://openwhisk.blog/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://openwhisk.blog/css/main.css><link rel=stylesheet type=text/css media=screen href=https://openwhisk.blog/css/all.css><link rel=stylesheet href=https://openwhisk.blog/css/katex.min.css crossorigin=anonymous><script defer src=https://openwhisk.blog/js/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://openwhisk.blog/js/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><link rel=stylesheet type=text/css media=screen href=https://openwhisk.blog/css/custom.css><title>Deploy MicroK8s with cloud-init | OpenWhisk and friends</title></head><body><header><div id=avatar><a href=https://openwhisk.blog/><img src=/img/pagurus-cartoon.png alt="OpenWhisk and friends"></a></div><div id=titletext><h2 id=title><a href=https://openwhisk.blog/>OpenWhisk and friends</a></h2></div><div id=title-description><p id=subtitle><a href=https://linkedin.com/in/msciab>Michele Sciabarra</a> blog advocating <a href=http://openwhisk.apache.org/>Apache OpenWhisk</a>.</p><div id=social><nav><ul><li><a href=https://github.com/openwhisk-blog><i title=Github class="icons fab fa-github"></i></a></li><li><a href=/index.xml><i title=RSS class="icons fas fa-rss"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/post>All Posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>09</span>
<span class=rest>Jun 2021</span></div></div><div class=matter><h1 class=title>Deploy MicroK8s with cloud-init</h1></div></div><div class=markdown><p>If you need to run Kubernetes, today very frequently you just pick one managed in some cloud provider. However this option is frequently expensive. A cheaper option is to get a bunch of virtual machines and install Kubernetes in it.</p><p>Creating a Kubernetes cluster actually today is pretty simple, using tools like <a href=https://microk8s.io/>MicroK8s</a> but there are still some manual actions to take.</p><p>To make cluster building even simpler, you can use for example <a href=https://cloudinit.readthedocs.io/en/latest/>cloud-init</a>, the standard for cloud image initialization. So I decided to write a cloud-init that can automatically build a cluster for you.</p><p>The result is <a href=https://bit.ly/microk8s-init>here</a>, you can download it with this command:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>curl -sL bit.ly/microk8s-init &gt;microk8s-init.yaml
</code></pre></div><p>To entirely automate the cluster generation I had to use a couple of tricks.</p><p>First I assigned statically an IP address to virtual machines. I assign ips to virtual machines using a number that is expected to be included in the hostname. Second I generate &ldquo;programmatically&rdquo; a token to join the cluster.</p><p>There are hence a couple of parameters you may need to customize before using it. You may need to change the <code>NET</code> parameter. All the virtual machines will get an IP in that network according to the host name. For example, the virtual machine <code>kube1</code> will get the address <code>10.0.0.1</code>. Also note that the <code>1</code> virtual machine is always the one used to join the cluster</p><p>Also for security you may want to change the <code>PASS</code> parameter that is the password used to generate the unique token for joining the cluster.</p><p>The script can be used in many different environments. The low hanging fruit to use it is wth <a href=https://multipass.run/><code>multipass</code></a>, another handy tool from Ubuntu to launch virtual machines in multiple environments.</p><p>Microk8s requires at least 2gb of memory to run and 2 vcpu. You can hence test the script with the following commands to create the first node of a local cluster:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>multipass launch -nkube1 -m3g -c2 --cloud-init microk8s-init.yaml
</code></pre></div><p>Sometimes it will time out during the initialization so you may need to wait for it to complete with</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>multipass exec kube1 -- sudo cloud-init status --wait
</code></pre></div><p>You can then launch more instances and wait for them:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>multipass launch -nkube2 -m2g -c2 --cloud-init microk8s-init.yaml
multipass exec kube2 -- sudo cloud-init status --wait
multipass launch -nkube3 -m2g -c2 --cloud-init microk8s-init.yaml
multipass exec kube3 -- sudo cloud-init status --wait
</code></pre></div><p>You can finally extract the configuration file and check for the cluster status with:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>multipass transfer kube1:/etc/kubeconfig ~/.kube/config
kubectl get nodes
</code></pre></div></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/kubernetes/>kubernetes</a></div><div class=clearit></div></div></div></div></main><footer>© Copyright <a href=https://www.linkedin.com/in/msciab>Michele Sciabarrà</a> | Book <a href=https://www.oreilly.com/library/view/learning-apache-openwhisk/9781492046158/>Learning Apache OpenWhisk</a> published by <a href=https://www.oreilly.com/>O&rsquo;Reilly</a><div><b>Disclaimer</b>: opinions expressed are solely my own and do not express<br>the views or opinions of the <a href=https://www.apache.org>Apache Software Foundation</a>.</div></footer></body></html>